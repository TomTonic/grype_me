---
name: Security Badge

on:
  schedule:
    # GitHub Actions cron is UTC. 08:00 UTC daily.
    - cron: '0 8 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  update-badge:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Ensure required secrets and variables are set
        shell: bash
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ vars.GRYPE_BADGE_GIST_ID }}
        run: |
          set -euo pipefail
          if [[ -z "$GIST_TOKEN" ]]; then
            echo "Missing required secret: GIST_TOKEN" >&2
            exit 1
          fi
          if [[ -z "$GIST_ID" ]]; then
            echo "Missing required repository variable: GRYPE_BADGE_GIST_ID" >&2
            exit 1
          fi

      - name: Checkout repository (with tags)
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: grype_me latest_release
        id: grype_me
        uses: TomTonic/grype_me@v1
        with:
          scan: 'latest_release'
          fail-build: false

      - name: Write badge data to gist
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: ${{ vars.GRYPE_BADGE_GIST_ID }}
          filename: grype-badge.json
          label: âœŠ grype_me
          message: ${{ steps.grype_me.outputs.badge-message }} in latest release
# alt:    message: "${{ steps.grype_me.outputs.badge-date }}: ${{ steps.grype_me.outputs.badge-counts }} CVEs in latest release"
          color: ${{ steps.grype_me.outputs.badge-color }}
